name: GAIA Root CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: false

    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install ruff pytest

    - name: Validate registry.json
      run: |
        python -c "
        import json
        data = json.load(open('registry.json'))
        count = len(data.get('projects', []))
        print(f'Registry valid: {count} projects')
        "

    - name: Check MANIFEST exists
      run: test -f GAIA_MANIFEST.md && echo "MANIFEST present" || (echo "MANIFEST missing" && exit 1)

    - name: Validate specs (if changes/ exists)
      run: |
        if [ -d "changes" ]; then
          python .claude/skills/validating-specs/scripts/validate_specs.py --all --check-only
        else
          echo "No changes/ directory, skipping spec validation"
        fi

    - name: Run runtime tests
      run: |
        if [ -d "runtime/tests" ]; then
          pytest runtime/tests/ -v --tb=short \
            --ignore=runtime/tests/test_gaia_viz_integration.py \
            --ignore=runtime/tests/test_gaia_viz_server.py
        else
          echo "No runtime tests found"
        fi

    - name: Lint Python files
      run: ruff check --select E,F,W --ignore E501 runtime/ .claude/skills/ || true
